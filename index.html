<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é’ç¡å±…æˆæœ¬ä¸è¿›å±•ç®¡ç†</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
  <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .progress-bar { height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; }
    .progress-fill { height: '100%'; background: #3b82f6; transition: width 0.3s; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // ğŸ”¥ Firebase é…ç½®
    const firebaseConfig = {
      apiKey: "AIzaSyAXlAEJUHEagJ3GDHIFfJV9AnAAPAIAC8g",
      authDomain: "qinglanju-9ca26.firebaseapp.com",
      databaseURL: "https://qinglanju-9ca26-default-rtdb.firebaseio.com",
      projectId: "qinglanju-9ca26",
      storageBucket: "qinglanju-9ca26.firebasestorage.app",
      messagingSenderId: "172568618102",
      appId: "1:172568618102:web:6887b8d89cc894c9642b57"
    };

    // åˆå§‹åŒ– Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.database();

    // ç®¡ç†å‘˜é‚®ç®±åˆ—è¡¨ï¼ˆå¯æ‰©å±•ä¸ºæ•°æ®åº“å­˜å‚¨ï¼‰
    const ADMIN_EMAILS = ["admin@qinglanju.com", "manager@qinglanju.com"];

    const defaultCategories = [
      'é™¢å¢™', 'å¤–é™¢', 'å†…é™¢', 'ä¸‹æ²‰åº­é™¢', 'è´Ÿä¸€æ¥¼', 'æ­£æˆ¿', 'ä¸œå¢æˆ¿', 'è¥¿å¢æˆ¿',
      'æ´—è¡£æˆ¿', 'èœå›­', 'åŒ–ç²ªæ± ', 'æˆ·å¤–å…¬å…±å«ç”Ÿé—´', 'å‡å±±æ¸©æ³‰', 'è¿›æ°´ç³»ç»Ÿ',
      'ç”µæºç³»ç»Ÿ', 'é›¨æ°´æ’æ°´ç³»ç»Ÿ', 'æ±¡æ°´ç³»ç»Ÿ', 'å¨æˆ¿æ’æ°´ç³»ç»Ÿ'
    ];

    function App() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [isLogin, setIsLogin] = useState(true);
      const [error, setError] = useState('');
      const [showReset, setShowReset] = useState(false);

      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged((user) => {
          setUser(user);
          setLoading(false);
        });
        return () => unsubscribe();
      }, []);

      const isManager = user && ADMIN_EMAILS.includes(user.email);

      if (loading) return <div className="p-8 text-center">åŠ è½½ä¸­...</div>;

      if (!user) {
        return (
          <AuthPage
            email={email}
            setEmail={setEmail}
            password={password}
            setPassword={setPassword}
            isLogin={isLogin}
            setIsLogin={setIsLogin}
            error={error}
            setError={setError}
            showReset={showReset}
            setShowReset={setShowReset}
          />
        );
      }

      return (
        <MainApp
          user={user}
          isManager={isManager}
          onLogout={() => auth.signOut()}
          ADMIN_EMAILS={ADMIN_EMAILS}
        />
      );
    }

    // ç™»å½•/æ³¨å†Œé¡µé¢
    function AuthPage({ email, setEmail, password, setPassword, isLogin, setIsLogin, error, setError, showReset, setShowReset }) {
      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        try {
          if (showReset) {
            await auth.sendPasswordResetEmail(email);
            alert('é‡ç½®å¯†ç é“¾æ¥å·²å‘é€è‡³é‚®ç®±');
            setShowReset(false);
          } else if (isLogin) {
            await auth.signInWithEmailAndPassword(email, password);
          } else {
            await auth.createUserWithEmailAndPassword(email, password);
            // æ–°ç”¨æˆ·è‡ªåŠ¨åˆ›å»ºé»˜è®¤ categories
            const userId = auth.currentUser.uid;
            const userRef = db.ref(`users/${userId}`);
            const snapshot = await userRef.once('value');
            if (!snapshot.val()) {
              await userRef.set({
                categories: defaultCategories.map((name, index) => ({
                  id: (index + 1).toString(),
                  name,
                  isDefault: true
                })),
                createdAt: new Date().toISOString()
              });
            }
          }
        } catch (err) {
          setError(err.message);
        }
      };

      return (
        <div className="min-h-screen flex items-center justify-center bg-blue-50 p-4">
          <div className="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
            <h2 className="text-2xl font-bold text-center mb-6 text-blue-600">
              {showReset ? 'é‡ç½®å¯†ç ' : isLogin ? 'ç™»å½•' : 'æ³¨å†Œ'}
            </h2>

            <form onSubmit={handleSubmit}>
              <div className="mb-4">
                <label className="block text-sm font-medium mb-1">é‚®ç®±</label>
                <input
                  type="email"
                  required
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="w-full border rounded p-2"
                  placeholder="your@company.com"
                />
              </div>
              {!showReset && (
                <div className="mb-4">
                  <label className="block text-sm font-medium mb-1">å¯†ç </label>
                  <input
                    type="password"
                    required
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    className="w-full border rounded p-2"
                    minLength="6"
                  />
                </div>
              )}

              {error && <p className="text-red-500 text-sm mb-4">{error}</p>}

              <div className="space-y-3">
                <button type="submit" className="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">
                  {showReset ? 'å‘é€é‡ç½®é“¾æ¥' : isLogin ? 'ç™»å½•' : 'æ³¨å†Œ'}
                </button>

                <div className="flex gap-2">
                  <button
                    type="button"
                    onClick={() => setIsLogin(!isLogin)}
                    className="flex-1 bg-gray-200 text-gray-700 py-2 rounded text-sm"
                  >
                    {isLogin ? 'å»æ³¨å†Œ' : 'å»ç™»å½•'}
                  </button>
                  <button
                    type="button"
                    onClick={() => setShowReset(!showReset)}
                    className="flex-1 bg-gray-200 text-gray-700 py-2 rounded text-sm"
                  >
                    {showReset ? 'è¿”å›ç™»å½•' : 'å¿˜è®°å¯†ç ï¼Ÿ'}
                  </button>
                </div>
              </div>
            </form>

            <div className="mt-6 text-center text-sm text-gray-500">
              <p>ç¤ºä¾‹è´¦å·ï¼š</p>
              <p>ç®¡ç†å‘˜: <code>admin@qinglanju.com</code></p>
              <p>æ™®é€šç”¨æˆ·: <code>user@qinglanju.com</code></p>
              <p>å¯†ç : <code>123456</code></p>
            </div>
          </div>
        </div>
      );
    }

    // ä¸»åº”ç”¨
    function MainApp({ user, isManager, onLogout, ADMIN_EMAILS }) {
      const [projects, setProjects] = useState([]);
      const [details, setDetails] = useState([]);
      const [categories, setCategories] = useState([]);
      const [currentView, setCurrentView] = useState('projects');
      const [currentProjectId, setCurrentProjectId] = useState(null);
      const [filterStatus, setFilterStatus] = useState('å…¨éƒ¨');
      const [detailFilterCategory, setDetailFilterCategory] = useState('å…¨éƒ¨');
      const [showAddProject, setShowAddProject] = useState(false);
      const [showEditProject, setShowEditProject] = useState(false);
      const [showAddDetail, setShowAddDetail] = useState(false);
      const [editProjectData, setEditProjectData] = useState({});
      const [newDetailData, setNewDetailData] = useState({
        id: '',
        detailName: '',
        categoryId: '',
        budgetArea: '',
        budgetQuantity: '',
        budgetCost: '',
        currentQuantity: '',
        currentCost: ''
      });
      const [importModal, setImportModal] = useState(false);
      const [file, setFile] = useState(null);
      const [manageUsers, setManageUsers] = useState(false); // ç®¡ç†å‘˜åŠŸèƒ½

      const projectStatuses = [
        'é¡¹ç›®è§„åˆ’ä¸­', 'é¡¹ç›®å·²å¯åŠ¨', 'æ¡†æ¶å»ºè®¾ä¸­', 'æ¡†æ¶å·²å®Œæˆ', 'é¡¹ç›®è£…ä¿®ä¸­', 'é¡¹ç›®å·²å®Œæˆ'
      ];

      useEffect(() => {
        loadUserData();
      }, [user]);

      const loadUserData = async () => {
        const userId = user.uid;
        const userRef = db.ref(`users/${userId}`);
        const snapshot = await userRef.once('value');
        const userData = snapshot.val() || {
          categories: defaultCategories.map((name, index) => ({
            id: (index + 1).toString(),
            name,
            isDefault: true
          }))
        };
        setCategories(userData.categories || []);

        // åŠ è½½é¡¹ç›®ï¼šç®¡ç†å‘˜çœ‹æ‰€æœ‰ï¼Œæ™®é€šç”¨æˆ·çœ‹è‡ªå·±çš„
        const projectsRef = isManager
          ? db.ref('projects')
          : db.ref('projects').orderByChild('userId').equalTo(userId);

        projectsRef.on('value', (snapshot) => {
          const data = snapshot.val() || {};
          const projectList = Object.keys(data).map(key => ({ id: key, ...data[key] }));
          setProjects(projectList);
        });

        // åŠ è½½æ˜ç»†
        db.ref('details').orderByChild('projectId').on('value', (snapshot) => {
          const data = snapshot.val() || {};
          const detailList = Object.keys(data).map(key => ({ id: key, ...data[key] }));
          setDetails(detailList);
        });
      };

      const saveData = async (path, data) => {
        await db.ref(path).set(data);
      };

      const addProject = async (project) => {
        const newProject = {
          name: project.name,
          status: project.status,
          budgetValue: parseFloat(project.budgetValue) || 0,
          budgetUsed: 0,
          progressPercent: 0,
          userId: user.uid,
          createdAt: new Date().toISOString()
        };
        const ref = db.ref('projects').push();
        await ref.set(newProject);
        const projectWithId = { id: ref.key, ...newProject };
        setProjects(prev => [...prev, projectWithId]);
      };

      const updateProject = async (updatedProject) => {
        const { id, ...data } = updatedProject;
        await db.ref(`projects/${id}`).set(data);
        setProjects(prev => prev.map(p => p.id === id ? { id, ...data } : p));

        // æ›´æ–°é¢„ç®—ä½¿ç”¨
        const projectDetails = details.filter(d => d.projectId === id);
        const totalUsed = projectDetails.reduce((sum, d) => sum + (parseFloat(d.currentCost) || 0), 0);
        const progress = data.budgetValue > 0 ? (totalUsed / data.budgetValue) * 100 : 0;
        const finalData = { ...data, budgetUsed: totalUsed, progressPercent: progress };
        await db.ref(`projects/${id}`).set(finalData);
        setProjects(prev => prev.map(p => p.id === id ? { id, ...finalData } : p));
      };

      const deleteProject = async (id) => {
        if (!window.confirm('ç¡®è®¤è¦åˆ é™¤é¡¹ç›®å—ï¼Ÿè¯¥æ“ä½œå°†åŒæ—¶åˆ é™¤å…¶æ‰€æœ‰æ˜ç»†è®°å½•ï¼Œä¸”æ— æ³•æ¢å¤ã€‚')) return;
        await db.ref(`projects/${id}`).remove();
        await db.ref('details').orderByChild('projectId').equalTo(id).once('value', (snapshot) => {
          const updates = {};
          snapshot.forEach(child => {
            updates[child.key] = null;
          });
          db.ref('details').update(updates);
        });
        setProjects(prev => prev.filter(p => p.id !== id));
        setDetails(prev => prev.filter(d => d.projectId !== id));
      };

      const addDetail = async (detail) => {
        const newDetail = {
          projectId: currentProjectId,
          detailName: detail.detailName,
          categoryId: detail.categoryId,
          budgetArea: parseFloat(detail.budgetArea) || null,
          budgetQuantity: parseFloat(detail.budgetQuantity) || 0,
          budgetCost: parseFloat(detail.budgetCost) || 0,
          currentQuantity: parseFloat(detail.currentQuantity) || 0,
          currentCost: parseFloat(detail.currentCost) || 0,
          createdAt: new Date().toISOString()
        };
        const ref = db.ref('details').push();
        await ref.set(newDetail);
        const detailWithId = { id: ref.key, ...newDetail };
        setDetails(prev => [...prev, detailWithId]);

        // æ›´æ–°é¡¹ç›®
        const project = projects.find(p => p.id === currentProjectId);
        if (project) {
          const totalUsed = [...details, detailWithId]
            .filter(d => d.projectId === currentProjectId)
            .reduce((sum, d) => sum + d.currentCost, 0);
          const progress = project.budgetValue > 0 ? (totalUsed / project.budgetValue) * 100 : 0;
          const updatedProject = { ...project, budgetUsed: totalUsed, progressPercent: progress };
          updateProject(updatedProject);
        }
      };

      const updateDetail = async (updatedDetail) => {
        const { id, ...data } = updatedDetail;
        await db.ref(`details/${id}`).set(data);
        setDetails(prev => prev.map(d => d.id === id ? { id, ...data } : d));

        const project = projects.find(p => p.id === updatedDetail.projectId);
        if (project) {
          const totalUsed = details
            .filter(d => d.projectId === updatedDetail.projectId)
            .reduce((sum, d) => sum + d.currentCost, 0);
          const progress = project.budgetValue > 0 ? (totalUsed / project.budgetValue) * 100 : 0;
          const updatedProject = { ...project, budgetUsed: totalUsed, progressPercent: progress };
          updateProject(updatedProject);
        }
      };

      const deleteDetail = async (id) => {
        if (!window.confirm('ç¡®è®¤åˆ é™¤æ­¤æ˜ç»†ï¼Ÿ')) return;
        const detail = details.find(d => d.id === id);
        await db.ref(`details/${id}`).remove();
        setDetails(prev => prev.filter(d => d.id !== id));

        const project = projects.find(p => p.id === detail.projectId);
        if (project) {
          const totalUsed = details
            .filter(d => d.projectId === detail.projectId && d.id !== id)
            .reduce((sum, d) => sum + d.currentCost, 0);
          const progress = project.budgetValue > 0 ? (totalUsed / project.budgetValue) * 100 : 0;
          const updatedProject = { ...project, budgetUsed: totalUsed, progressPercent: progress };
          updateProject(updatedProject);
        }
      };

      const importCSV = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        setFile(file);
        setImportModal(true);
      };

      const confirmImport = () => {
        const reader = new FileReader();
        reader.onload = async (e) => {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet);

          const newDetails = json.map(row => {
            const cat = categories.find(c => c.name === row.åˆ†é¡¹åç§°);
            return {
              projectId: currentProjectId,
              detailName: row.è¯¦ç»†åç§° || 'æœªå‘½å',
              categoryId: cat ? cat.id : categories[0]?.id || '1',
              budgetArea: parseFloat(row.é¢„ç®—é¢ç§¯) || null,
              budgetQuantity: parseFloat(row.é¢„ç®—ç”¨é‡) || 0,
              budgetCost: parseFloat(row.é¢„ç®—è´¹ç”¨) || 0,
              currentQuantity: parseFloat(row.å½“å‰ä½¿ç”¨é‡) || 0,
              currentCost: parseFloat(row.å½“å‰ä½¿ç”¨è´¹ç”¨) || 0,
              createdAt: new Date().toISOString()
            };
          }).filter(d => d.detailName !== 'æœªå‘½å');

          const batch = {};
          newDetails.forEach(detail => {
            const ref = db.ref('details').push();
            batch[ref.key] = detail;
          });
          await db.ref('details').update(batch);
          setDetails(prev => [...prev, ...Object.values(batch).map((d, i) => ({ id: Object.keys(batch)[i], ...d }))]);

          const project = projects.find(p => p.id === currentProjectId);
          if (project) {
            const totalUsed = [...details, ...Object.values(batch)]
              .filter(d => d.projectId === currentProjectId)
              .reduce((sum, d) => sum + d.currentCost, 0);
            const progress = project.budgetValue > 0 ? (totalUsed / project.budgetValue) * 100 : 0;
            const updatedProject = { ...project, budgetUsed: totalUsed, progressPercent: progress };
            updateProject(updatedProject);
          }

          setImportModal(false);
          setFile(null);
          alert('å¯¼å…¥æˆåŠŸï¼');
        };
        reader.readAsArrayBuffer(file);
      };

      const downloadTemplate = () => {
        const templateData = [
          { è¯¦ç»†åç§°: 'åŒ—ä¾§é™¢å¢™ç Œç­‘', åˆ†é¡¹åç§°: 'é™¢å¢™', é¢„ç®—é¢ç§¯: 50, é¢„ç®—ç”¨é‡: 100, é¢„ç®—è´¹ç”¨: 8000, å½“å‰ä½¿ç”¨é‡: 95, å½“å‰ä½¿ç”¨è´¹ç”¨: 7600 },
          { è¯¦ç»†åç§°: 'ç”µæºå¸ƒçº¿å®‰è£…', åˆ†é¡¹åç§°: 'ç”µæºç³»ç»Ÿ', é¢„ç®—é¢ç§¯: '', é¢„ç®—ç”¨é‡: 200, é¢„ç®—è´¹ç”¨: 15000, å½“å‰ä½¿ç”¨é‡: 190, å½“å‰ä½¿ç”¨è´¹ç”¨: 14500 }
        ];
        const ws = XLSX.utils.json_to_sheet(templateData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'æ˜ç»†å¯¼å…¥');
        XLSX.writeFile(wb, 'é’ç¡å±…-æ˜ç»†å¯¼å…¥æ¨¡æ¿.xlsx');
      };

      const filteredProjects = filterStatus === 'å…¨éƒ¨'
        ? projects
        : projects.filter(p => p.status === filterStatus);

      const currentProject = projects.find(p => p.id === currentProjectId);
      const projectDetails = details.filter(d => d.projectId === currentProjectId);
      const filteredDetails = detailFilterCategory === 'å…¨éƒ¨'
        ? projectDetails
        : projectDetails.filter(d => {
            const cat = categories.find(c => c.id === d.categoryId);
            return cat ? cat.name === detailFilterCategory : false;
          });

      const categoryStats = {};
      filteredDetails.forEach(d => {
        const cat = categories.find(c => c.id === d.categoryId);
        const name = cat?.name || 'æœªçŸ¥';
        if (!categoryStats[name]) {
          categoryStats[name] = { budgetCost: 0, currentCost: 0, budgetQuantity: 0, currentQuantity: 0 };
        }
        categoryStats[name].budgetCost += d.budgetCost;
        categoryStats[name].currentCost += d.currentCost;
        categoryStats[name].budgetQuantity += d.budgetQuantity;
        categoryStats[name].currentQuantity += d.currentQuantity;
      });

      return (
        <div className="min-h-screen">
          <header className="bg-white shadow-sm p-4 flex items-center justify-between">
            <h1 className="text-xl font-bold text-blue-600">é’ç¡å±…</h1>
            <div className="flex items-center gap-2">
              <span className="text-sm text-gray-600">
                {isManager ? 'ç®¡ç†å‘˜' : 'ç”¨æˆ·'}: {user.email}
              </span>
              <button
                onClick={() => setManageUsers(true)}
                className="text-xs bg-gray-200 px-2 py-1 rounded"
              >
                ç”¨æˆ·ç®¡ç†
              </button>
              <button
                onClick={onLogout}
                className="text-red-500 text-sm"
              >
                é€€å‡º
              </button>
            </div>
          </header>

          {currentView === 'projects' && (
            <div className="p-4">
              <div className="mb-4">
                <select
                  value={filterStatus}
                  onChange={(e) => setFilterStatus(e.target.value)}
                  className="border rounded p-2"
                >
                  <option value="å…¨éƒ¨">å…¨éƒ¨</option>
                  {projectStatuses.map(s => <option key={s} value={s}>{s}</option>)}
                </select>
              </div>
              {filteredProjects.length === 0 ? (
                <p className="text-gray-500 text-center py-8">æš‚æ— é¡¹ç›®</p>
              ) : (
                filteredProjects.map(p => (
                  <div key={p.id} className="bg-white p-4 mb-4 rounded-lg shadow">
                    <h2 className="font-semibold">{p.name}</h2>
                    <p className="text-sm text-gray-600">{p.status}</p>
                    <p className="text-sm mt-1">é¢„ç®—ï¼šÂ¥{p.budgetValue.toLocaleString()} / Â¥{p.budgetUsed.toLocaleString()}</p>
                    <div className="progress-bar mt-2">
                      <div
                        className="progress-fill"
                        style={{ width: `${Math.min(p.progressPercent, 100)}%` }}
                      ></div>
                    </div>
                    <p className="text-xs text-gray-500 mt-1">{p.progressPercent.toFixed(1)}% è¿›å±•</p>
                    <div className="flex gap-2 mt-3">
                      <button
                        onClick={() => {
                          setCurrentProjectId(p.id);
                          setCurrentView('details');
                        }}
                        className="bg-green-500 text-white text-xs px-3 py-1 rounded"
                      >
                        æ˜ç»†
                      </button>
                      <button
                        onClick={() => {
                          setEditProjectData(p);
                          setShowEditProject(true);
                        }}
                        className="bg-yellow-500 text-white text-xs px-3 py-1 rounded"
                      >
                        ç¼–è¾‘
                      </button>
                      <button
                        onClick={() => deleteProject(p.id)}
                        className="bg-red-500 text-white text-xs px-3 py-1 rounded"
                      >
                        åˆ é™¤
                      </button>
                    </div>
                  </div>
                ))
              )}
              <button
                onClick={() => setShowAddProject(true)}
                className="mt-4 bg-blue-500 text-white px-4 py-2 rounded-full text-sm shadow"
              >
                + æ–°å¢é¡¹ç›®
              </button>
            </div>
          )}

          {currentView === 'details' && currentProject && (
            <div className="p-4">
              <h2 className="text-lg font-semibold mb-2">{currentProject.name} - æ˜ç»†ç®¡ç†</h2>
              <div className="flex flex-wrap gap-2 mb-4">
                <select
                  value={detailFilterCategory}
                  onChange={(e) => setDetailFilterCategory(e.target.value)}
                  className="border rounded p-2 text-sm"
                >
                  <option value="å…¨éƒ¨">å…¨éƒ¨åˆ†é¡¹</option>
                  {categories.map(c => (
                    <option key={c.id} value={c.name}>{c.name}</option>
                  ))}
                </select>
                <button
                  onClick={() => {
                    setNewDetailData({
                      id: '',
                      detailName: '',
                      categoryId: categories[0]?.id || '1',
                      budgetArea: '',
                      budgetQuantity: '',
                      budgetCost: '',
                      currentQuantity: '',
                      currentCost: ''
                    });
                    setShowAddDetail(true);
                  }}
                  className="bg-blue-500 text-white text-sm px-3 py-1 rounded"
                >
                  æ–°å¢æ˜ç»†
                </button>
                <label className="bg-green-500 text-white text-sm px-3 py-1 rounded cursor-pointer">
                  å¯¼å…¥
                  <input type="file" accept=".xlsx,.xls,.csv" onChange={importCSV} className="hidden" />
                </label>
                <button
                  onClick={downloadTemplate}
                  className="bg-purple-500 text-white text-sm px-3 py-1 rounded"
                >
                  ä¸‹è½½æ¨¡æ¿
                </button>
              </div>

              <div className="bg-white p-3 rounded mb-4">
                <h3 className="font-medium mb-2">åˆ†é¡¹ç»Ÿè®¡</h3>
                {Object.keys(categoryStats).length === 0 ? (
                  <p className="text-gray-500 text-sm">æš‚æ— æ•°æ®</p>
                ) : (
                  <div className="text-sm">
                    {Object.entries(categoryStats).map(([name, stat]) => (
                      <div key={name} className="py-1 border-b border-gray-100">
                        <div className="flex justify-between">
                          <span>{name}</span>
                          <span>Â¥{stat.currentCost.toFixed(0)}/{stat.budgetCost.toFixed(0)}</span>
                        </div>
                        <div className="text-xs text-gray-500">
                          ç”¨é‡: {stat.currentQuantity.toFixed(1)}/{stat.budgetQuantity.toFixed(1)}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {filteredDetails.length === 0 ? (
                <p className="text-gray-500 text-center py-8">æš‚æ— æ˜ç»†</p>
              ) : (
                filteredDetails.map(d => {
                  const cat = categories.find(c => c.id === d.categoryId);
                  return (
                    <div key={d.id} className="bg-white p-3 mb-3 rounded shadow-sm">
                      <h3 className="font-medium">{d.detailName}</h3>
                      <p className="text-xs text-gray-600">åˆ†é¡¹: {cat?.name || 'æœªçŸ¥'}</p>
                      <p className="text-sm mt-1">
                        é¢„ç®—: Â¥{d.budgetCost} | ä½¿ç”¨: Â¥{d.currentCost}
                      </p>
                      <div className="flex gap-2 mt-2">
                        <button
                          onClick={() => {
                            setNewDetailData({ ...d, categoryId: d.categoryId.toString() });
                            setShowAddDetail(true);
                          }}
                          className="text-blue-500 text-xs"
                        >
                          ç¼–è¾‘
                        </button>
                        <button
                          onClick={() => deleteDetail(d.id)}
                          className="text-red-500 text-xs"
                        >
                          åˆ é™¤
                        </button>
                      </div>
                    </div>
                  );
                })
              )}
            </div>
          )}

          {showAddProject && (
            <ProjectForm
              onClose={() => setShowAddProject(false)}
              onSubmit={addProject}
              projectStatuses={projectStatuses}
            />
          )}

          {showEditProject && (
            <ProjectForm
              onClose={() => setShowEditProject(false)}
              onSubmit={updateProject}
              projectStatuses={projectStatuses}
              initialData={editProjectData}
            />
          )}

          {showAddDetail && (
            <DetailForm
              onClose={() => {
                setShowAddDetail(false);
                setNewDetailData({
                  id: '',
                  detailName: '',
                  categoryId: '',
                  budgetArea: '',
                  budgetQuantity: '',
                  budgetCost: '',
                  currentQuantity: '',
                  currentCost: ''
                });
              }}
              onSubmit={newDetailData.id ? updateDetail : addDetail}
              categories={categories}
              initialData={newDetailData}
            />
          )}

          {importModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white p-6 rounded-lg max-w-md w-full">
                <h3 className="text-lg font-semibold mb-4">ç¡®è®¤å¯¼å…¥</h3>
                <p>å³å°†å¯¼å…¥ {file.name}ï¼Œç¡®è®¤ç»§ç»­ï¼Ÿ</p>
                <div className="flex gap-2 mt-6">
                  <button
                    onClick={() => setImportModal(false)}
                    className="flex-1 bg-gray-300 text-black py-2 rounded"
                  >
                    å–æ¶ˆ
                  </button>
                  <button
                    onClick={confirmImport}
                    className="flex-1 bg-blue-500 text-white py-2 rounded"
                  >
                    ç¡®è®¤å¯¼å…¥
                  </button>
                </div>
              </div>
            </div>
          )}

          {manageUsers && (
            <UserManagement
              onClose={() => setManageUsers(false)}
              user={user}
              ADMIN_EMAILS={ADMIN_EMAILS}
            />
          )}
        </div>
      );
    }

    function ProjectForm({ onClose, onSubmit, projectStatuses, initialData }) {
      const isEdit = !!initialData;
      const [formData, setFormData] = useState(
        initialData || {
          name: '',
          status: 'é¡¹ç›®è§„åˆ’ä¸­',
          budgetValue: ''
        }
      );

      const handleSubmit = (e) => {
        e.preventDefault();
        onSubmit(formData);
        onClose();
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white p-6 rounded-lg max-w-md w-full">
            <h3 className="text-lg font-semibold mb-4">{isEdit ? 'ç¼–è¾‘é¡¹ç›®' : 'æ–°å¢é¡¹ç›®'}</h3>
            <form onSubmit={handleSubmit}>
              <div className="mb-4">
                <label className="block text-sm font-medium mb-1">é¡¹ç›®åç§°</label>
                <input
                  type="text"
                  required
                  value={formData.name}
                  onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                  className="w-full border rounded p-2"
                />
              </div>
              <div className="mb-4">
                <label className="block text-sm font-medium mb-1">é¡¹ç›®çŠ¶æ€</label>
                <select
                  value={formData.status}
                  onChange={(e) => setFormData({ ...formData, status: e.target.value })}
                  className="w-full border rounded p-2"
                >
                  {projectStatuses.map(s => <option key={s} value={s}>{s}</option>)}
                </select>
              </div>
              <div className="mb-4">
                <label className="block text-sm font-medium mb-1">é¡¹ç›®é¢„ç®—å€¼(å…ƒ)</label>
                <input
                  type="number"
                  required
                  value={formData.budgetValue}
                  onChange={(e) => setFormData({ ...formData, budgetValue: e.target.value })}
                  className="w-full border rounded p-2"
                />
              </div>
              <div className="flex gap-2 mt-6">
                <button
                  type="button"
                  onClick={onClose}
                  className="flex-1 bg-gray-300 text-black py-2 rounded"
                >
                  å–æ¶ˆ
                </button>
                <button
                  type="submit"
                  className="flex-1 bg-blue-500 text-white py-2 rounded"
                >
                  {isEdit ? 'ä¿å­˜' : 'æ·»åŠ '}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    function DetailForm({ onClose, onSubmit, categories, initialData }) {
      const isEdit = !!initialData.id;
      const [formData, setFormData] = useState(
        initialData.id ? { ...initialData } : {
          detailName: '',
          categoryId: categories[0]?.id?.toString() || '',
          budgetArea: '',
          budgetQuantity: '',
          budgetCost: '',
          currentQuantity: '',
          currentCost: ''
        }
      );

      const handleSubmit = (e) => {
        e.preventDefault();
        onSubmit(formData);
        onClose();
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white p-6 rounded-lg max-w-md w-full">
            <h3 className="text-lg font-semibold mb-4">{isEdit ? 'ç¼–è¾‘æ˜ç»†' : 'æ–°å¢æ˜ç»†'}</h3>
            <form onSubmit={handleSubmit}>
              <div className="mb-4">
                <label className="block text-sm font-medium mb-1">è¯¦ç»†åç§°</label>
                <input
                  type="text"
                  required
                  value={formData.detailName}
                  onChange={(e) => setFormData({ ...formData, detailName: e.target.value })}
                  className="w-full border rounded p-2"
                />
              </div>
              <div className="mb-4">
                <label className="block text-sm font-medium mb-1">åˆ†é¡¹åç§°</label>
                <select
                  value={formData.categoryId}
                  onChange={(e) => setFormData({ ...formData, categoryId: e.target.value })}
                  className="w-full border rounded p-2"
                  required
                >
                  {categories.map(c => (
                    <option key={c.id} value={c.id}>{c.name}</option>
                  ))}
                </select>
              </div>
              <div className="mb-4">
                <label className="block text-sm font-medium mb-1">é¢„ç®—é¢ç§¯(ã¡)</label>
                <input
                  type="number"
                  step="0.01"
                  value={formData.budgetArea}
                  onChange={(e) => setFormData({ ...formData, budgetArea: e.target.value })}
                  className="w-full border rounded p-2"
                />
              </div>
              <div className="mb-4">
                <label className="block text-sm font-medium mb-1">é¢„ç®—ç”¨é‡</label>
                <input
                  type="number"
                  step="0.01"
                  required
                  value={formData.budgetQuantity}
                  onChange={(e) => setFormData({ ...formData, budgetQuantity: e.target.value })}
                  className="w-full border rounded p-2"
                />
              </div>
              <div className="mb-4">
                <label className="block text-sm font-medium mb-1">é¢„ç®—è´¹ç”¨(å…ƒ)</label>
                <input
                  type="number"
                  step="0.01"
                  required
                  value={formData.budgetCost}
                  onChange={(e) => setFormData({ ...formData, budgetCost: e.target.value })}
                  className="w-full border rounded p-2"
                />
              </div>
              <div className="mb-4">
                <label className="block text-sm font-medium mb-1">å½“å‰ä½¿ç”¨é‡</label>
                <input
                  type="number"
                  step="0.01"
                  required
                  value={formData.currentQuantity}
                  onChange={(e) => setFormData({ ...formData, currentQuantity: e.target.value })}
                  className="w-full border rounded p-2"
                />
              </div>
              <div className="mb-4">
                <label className="block text-sm font-medium mb-1">å½“å‰ä½¿ç”¨è´¹ç”¨(å…ƒ)</label>
                <input
                  type="number"
                  step="0.01"
                  required
                  value={formData.currentCost}
                  onChange={(e) => setFormData({ ...formData, currentCost: e.target.value })}
                  className="w-full border rounded p-2"
                />
              </div>
              <div className="flex gap-2 mt-6">
                <button
                  type="button"
                  onClick={onClose}
                  className="flex-1 bg-gray-300 text-black py-2 rounded"
                >
                  å–æ¶ˆ
                </button>
                <button
                  type="submit"
                  className="flex-1 bg-blue-500 text-white py-2 rounded"
                >
                  {isEdit ? 'ä¿å­˜' : 'æ·»åŠ '}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    function UserManagement({ onClose, user, ADMIN_EMAILS }) {
      const [users, setUsers] = useState([]);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        // æ¨¡æ‹Ÿä» Realtime Database è¯»å–ç”¨æˆ·åˆ—è¡¨ï¼ˆå®é™…éœ€ Admin SDKï¼‰
        db.ref('users').once('value').then(snapshot => {
          const data = snapshot.val() || {};
          const userList = Object.keys(data).map(key => ({
            uid: key,
            email: key, // ç®€åŒ–ï¼šuid = email
            createdAt: data[key].createdAt
          }));
          setUsers(userList);
          setLoading(false);
        });
      }, []);

      const deleteUser = async (uid, email) => {
        if (!window.confirm(`ç¡®è®¤åˆ é™¤ç”¨æˆ· ${email}ï¼Ÿ`)) return;
        // å®é™…åˆ é™¤éœ€ Admin SDKï¼Œæ­¤å¤„ä»…æç¤º
        alert('è¯·åœ¨ Firebase æ§åˆ¶å°æ‰‹åŠ¨åˆ é™¤ç”¨æˆ·');
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white p-6 rounded-lg max-w-md w-full max-h-96 overflow-y-auto">
            <h3 className="text-lg font-semibold mb-4">ç”¨æˆ·ç®¡ç†</h3>
            {loading ? (
              <p>åŠ è½½ä¸­...</p>
            ) : (
              <div className="space-y-2">
                {users.map(u => (
                  <div key={u.uid} className="flex justify-between items-center p-2 border rounded">
                    <div>
                      <p className="font-medium">{u.email}</p>
                      <p className="text-xs text-gray-500">{new Date(u.createdAt).toLocaleString()}</p>
                    </div>
                    {(ADMIN_EMAILS.includes(user.email) && user.email !== u.email) && (
                      <button
                        onClick={() => deleteUser(u.uid, u.email)}
                        className="text-red-500 text-sm"
                      >
                        åˆ é™¤
                      </button>
                    )}
                  </div>
                ))}
              </div>
            )}
            <p className="text-xs text-gray-500 mt-4">
              æç¤ºï¼šåˆ é™¤ç”¨æˆ·éœ€åœ¨ Firebase æ§åˆ¶å°æ“ä½œ
            </p>
            <button
              onClick={onClose}
              className="mt-4 w-full bg-gray-300 text-black py-2 rounded"
            >
              å…³é—­
            </button>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
