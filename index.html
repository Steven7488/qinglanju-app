<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>青灡居成本与进展管理（增强版）</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
  <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .progress-bar { height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; }
    .progress-fill { height: '100%'; background: #3b82f6; transition: width 0.3s; }
    .img-preview { width: 60px; height: 60px; object-fit: cover; border: 1px solid #ddd; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const firebaseConfig = {
      apiKey: "AIzaSyAXlAEJUHEagJ3GDHIFfJV9AnAAPAIAC8g",
      authDomain: "qinglanju-9ca26.firebaseapp.com",
      databaseURL: "https://qinglanju-9ca26-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "qinglanju-9ca26",
      storageBucket: "qinglanju-9ca26.firebasestorage.app",
      messagingSenderId: "172568618102",
      appId: "1:172568618102:web:6887b8d89cc894c9642b57"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    const ADMIN_EMAILS = ["admin@qinglanju.com", "manager@qinglanju.com"];
    const defaultCategories = [
      '院墙', '外院', '内院', '下沉庭院', '负一楼', '正房', '东厢房', '西厢房',
      '洗衣房', '菜园', '化粪池', '户外公共卫生间', '假山温泉', '进水系统',
      '电源系统', '雨水排水系统', '污水系统', '厨房排水系统'
    ];

    function App() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [isLogin, setIsLogin] = useState(true);
      const [error, setError] = useState('');
      const [showReset, setShowReset] = useState(false);

      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged((user) => {
          setUser(user);
          setLoading(false);
        });
        return () => unsubscribe();
      }, []);

      const isManager = user && ADMIN_EMAILS.includes(user.email);

      if (loading) return <div className="p-8 text-center">加载中...</div>;

      if (!user) {
        return (
          <AuthPage
            email={email}
            setEmail={setEmail}
            password={password}
            setPassword={setPassword}
            isLogin={isLogin}
            setIsLogin={setIsLogin}
            error={error}
            setError={setError}
            showReset={showReset}
            setShowReset={setShowReset}
          />
        );
      }

      return (
        <MainApp
          user={user}
          isManager={isManager}
          onLogout={() => auth.signOut()}
          ADMIN_EMAILS={ADMIN_EMAILS}
        />
      );
    }

    function AuthPage({ email, setEmail, password, setPassword, isLogin, setIsLogin, error, setError, showReset, setShowReset }) {
      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        try {
          if (showReset) {
            await auth.sendPasswordResetEmail(email);
            alert('重置密码链接已发送至邮箱');
            setShowReset(false);
          } else if (isLogin) {
            await auth.signInWithEmailAndPassword(email, password);
          } else {
            await auth.createUserWithEmailAndPassword(email, password);
            const userId = auth.currentUser.uid;
            const userRef = db.ref(`users/${userId}`);
            const snapshot = await userRef.once('value');
            if (!snapshot.val()) {
              await userRef.set({
                categories: defaultCategories.map((name, index) => ({
                  id: (index + 1).toString(),
                  name,
                  isDefault: true
                })),
                createdAt: new Date().toISOString()
              });
            }
          }
        } catch (err) {
          setError(err.message);
        }
      };

      return (
        <div className="min-h-screen flex items-center justify-center bg-blue-50 p-4">
          <div className="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
            <h2 className="text-2xl font-bold text-center mb-6 text-blue-600">
              {showReset ? '重置密码' : isLogin ? '登录' : '注册'}
            </h2>
            <form onSubmit={handleSubmit}>
              <div className="mb-4">
                <label className="block text-sm font-medium mb-1">邮箱</label>
                <input
                  type="email"
                  required
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="w-full border rounded p-2"
                  placeholder="your@company.com"
                />
              </div>
              {!showReset && (
                <div className="mb-4">
                  <label className="block text-sm font-medium mb-1">密码</label>
                  <input
                    type="password"
                    required
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    className="w-full border rounded p-2"
                    minLength="6"
                  />
                </div>
              )}
              {error && <p className="text-red-500 text-sm mb-4">{error}</p>}
              <div className="space-y-3">
                <button type="submit" className="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">
                  {showReset ? '发送重置链接' : isLogin ? '登录' : '注册'}
                </button>
                <div className="flex gap-2">
                  <button
                    type="button"
                    onClick={() => setIsLogin(!isLogin)}
                    className="flex-1 bg-gray-200 text-gray-700 py-2 rounded text-sm"
                  >
                    {isLogin ? '去注册' : '去登录'}
                  </button>
                  <button
                    type="button"
                    onClick={() => setShowReset(!showReset)}
                    className="flex-1 bg-gray-200 text-gray-700 py-2 rounded text-sm"
                  >
                    {showReset ? '返回登录' : '忘记密码？'}
                  </button>
                </div>
              </div>
            </form>
            <div className="mt-6 text-center text-sm text-gray-500">
              <p>示例账号：</p>
              <p>管理员: <code>admin@qinglanju.com</code></p>
              <p>普通用户: <code>user@qinglanju.com</code></p>
              <p>密码: <code>123456</code></p>
            </div>
          </div>
        </div>
      );
    }

    function MainApp({ user, isManager, onLogout, ADMIN_EMAILS }) {
      const [projects, setProjects] = useState([]);
      const [details, setDetails] = useState([]);
      const [categories, setCategories] = useState([]);
      const [currentView, setCurrentView] = useState('projects');
      const [currentProjectId, setCurrentProjectId] = useState(null);
      const [currentDetailId, setCurrentDetailId] = useState(null);
      const [filterStatus, setFilterStatus] = useState('全部');
      const [detailFilterCategory, setDetailFilterCategory] = useState('全部');
      const [showAddProject, setShowAddProject] = useState(false);
      const [showEditProject, setShowEditProject] = useState(false);
      const [showAddDetail, setShowAddDetail] = useState(false);
      const [showEditDetail, setShowEditDetail] = useState(false);
      const [editProjectData, setEditProjectData] = useState({});
      const [newDetailData, setNewDetailData] = useState({
        detailName: '',
        categoryId: '',
        budgetArea: '',
        budgetQuantity: '',
        budgetCost: '',
        currentQuantity: '',
        currentCost: ''
      });
      const [editDetailData, setEditDetailData] = useState({});
      const [importModal, setImportModal] = useState(false);
      const [file, setFile] = useState(null);
      const [manageUsers, setManageUsers] = useState(false);
      const [progressModal, setProgressModal] = useState(false);
      const [budgetModal, setBudgetModal] = useState(false);
      const fileInputRef = useRef(null);

      const projectStatuses = [
        '项目规划中', '项目已启动', '框架建设中', '框架已完成', '项目装修中', '项目已完成'
      ];

      useEffect(() => {
        loadUserData();
      }, [user]);

      const loadUserData = async () => {
        const userId = user.uid;
        const userRef = db.ref(`users/${userId}`);
        const snapshot = await userRef.once('value');
        const userData = snapshot.val() || {
          categories: defaultCategories.map((name, index) => ({
            id: (index + 1).toString(),
            name,
            isDefault: true
          }))
        };
        setCategories(userData.categories || []);

        const projectsRef = isManager
          ? db.ref('projects')
          : db.ref('projects').orderByChild('userId').equalTo(userId);

        projectsRef.on('value', (snapshot) => {
          const data = snapshot.val() || {};
          const projectList = Object.keys(data).map(key => ({ id: key, ...data[key] }));
          setProjects(projectList);
        });

        db.ref('details').on('value', (snapshot) => {
          const data = snapshot.val() || {};
          const detailList = Object.keys(data).map(key => ({ id: key, ...data[key] }));
          setDetails(detailList);
        });
      };

      const saveData = async (path, data) => {
        await db.ref(path).set(data);
      };

      const addProject = async (project) => {
        const newProject = {
          name: project.name,
          status: project.status,
          budgetValue: parseFloat(project.budgetValue) || 0,
          budgetUsed: 0,
          progressPercent: 0,
          userId: user.uid,
          createdAt: new Date().toISOString()
        };
        const ref = db.ref('projects').push();
        await ref.set(newProject);
        const projectWithId = { id: ref.key, ...newProject };
        setProjects(prev => [...prev, projectWithId]);
      };

      const updateProject = async (updatedProject) => {
        const { id, ...data } = updatedProject;
        await db.ref(`projects/${id}`).set(data);
        setProjects(prev => prev.map(p => p.id === id ? { id, ...data } : p));

        const projectDetails = details.filter(d => d.projectId === id);
        const totalUsed = projectDetails.reduce((sum, d) => sum + (parseFloat(d.currentCost) || 0), 0);
        const progress = data.budgetValue > 0 ? (totalUsed / data.budgetValue) * 100 : 0;
        const finalData = { ...data, budgetUsed: totalUsed, progressPercent: progress };
        await db.ref(`projects/${id}`).set(finalData);
        setProjects(prev => prev.map(p => p.id === id ? { id, ...finalData } : p));
      };

      const deleteProject = async (id) => {
        if (!window.confirm('确认要删除项目吗？该操作将同时删除其所有明细记录，且无法恢复。')) return;
        await db.ref(`projects/${id}`).remove();
        await db.ref('details').orderByChild('projectId').equalTo(id).once('value', (snapshot) => {
          const updates = {};
          snapshot.forEach(child => {
            updates[child.key] = null;
          });
          db.ref('details').update(updates);
        });
        setProjects(prev => prev.filter(p => p.id !== id));
        setDetails(prev => prev.filter(d => d.projectId !== id));
      };

      const addDetail = async (detail) => {
        const newDetail = {
          projectId: currentProjectId,
          detailName: detail.detailName,
          categoryId: detail.categoryId,
          budgetArea: parseFloat(detail.budgetArea) || null,
          budgetQuantity: parseFloat(detail.budgetQuantity) || 0,
          budgetCost: parseFloat(detail.budgetCost) || 0,
          currentQuantity: parseFloat(detail.currentQuantity) || 0,
          currentCost: parseFloat(detail.currentCost) || 0,
          createdAt: new Date().toISOString(),
          progressItems: [],
          budgetItems: []
        };
        const ref = db.ref('details').push();
        await ref.set(newDetail);
        const detailWithId = { id: ref.key, ...newDetail };
        setDetails(prev => [...prev, detailWithId]);

        const project = projects.find(p => p.id === currentProjectId);
        if (project) {
          const totalUsed = [...details, detailWithId]
            .filter(d => d.projectId === currentProjectId)
            .reduce((sum, d) => sum + d.currentCost, 0);
          const progress = project.budgetValue > 0 ? (totalUsed / project.budgetValue) * 100 : 0;
          const updatedProject = { ...project, budgetUsed: totalUsed, progressPercent: progress };
          updateProject(updatedProject);
        }
      };

      const updateDetail = async (updatedDetail) => {
        const { id, ...data } = updatedDetail;
        await db.ref(`details/${id}`).update(data);
        setDetails(prev => prev.map(d => d.id === id ? { id, ...d, ...data } : d));

        const project = projects.find(p => p.id === updatedDetail.projectId);
        if (project) {
          const totalUsed = details
            .filter(d => d.projectId === updatedDetail.projectId)
            .reduce((sum, d) => sum + d.currentCost, 0);
          const progress = project.budgetValue > 0 ? (totalUsed / project.budgetValue) * 100 : 0;
          const updatedProject = { ...project, budgetUsed: totalUsed, progressPercent: progress };
          updateProject(updatedProject);
        }
      };

      const deleteDetail = async (id) => {
        if (!window.confirm('确认删除此明细？')) return;
        const detail = details.find(d => d.id === id);
        await db.ref(`details/${id}`).remove();
        setDetails(prev => prev.filter(d => d.id !== id));

        const project = projects.find(p => p.id === detail.projectId);
        if (project) {
          const totalUsed = details
            .filter(d => d.projectId === detail.projectId && d.id !== id)
            .reduce((sum, d) => sum + d.currentCost, 0);
          const progress = project.budgetValue > 0 ? (totalUsed / project.budgetValue) * 100 : 0;
          const updatedProject = { ...project, budgetUsed: totalUsed, progressPercent: progress };
          updateProject(updatedProject);
        }
      };

      const addProgressItem = async (detailId, item) => {
        const ref = db.ref(`details/${detailId}/progressItems`).push();
        await ref.set({ ...item, createdAt: new Date().toISOString() });
        const newItem = { id: ref.key, ...item };
        setDetails(prev => prev.map(d => d.id === detailId ? {
          ...d,
          progressItems: [...(d.progressItems || []), newItem]
        } : d));
        recalculateDetailProgress(detailId);
      };

      const updateProgressItem = async (detailId, itemId, updates) => {
        await db.ref(`details/${detailId}/progressItems/${itemId}`).update(updates);
        setDetails(prev => prev.map(d => d.id === detailId ? {
          ...d,
          progressItems: d.progressItems.map(i => i.id === itemId ? { ...i, ...updates } : i)
        } : d));
        recalculateDetailProgress(detailId);
      };

      const deleteProgressItem = async (detailId, itemId) => {
        await db.ref(`details/${detailId}/progressItems/${itemId}`).remove();
        setDetails(prev => prev.map(d => d.id === detailId ? {
          ...d,
          progressItems: d.progressItems.filter(i => i.id !== itemId)
        } : d));
        recalculateDetailProgress(detailId);
      };

      const recalculateDetailProgress = (detailId) => {
        const detail = details.find(d => d.id === detailId);
        if (!detail?.progressItems?.length) return;
        const avgProgress = detail.progressItems.reduce((sum, i) => sum + (parseFloat(i.progress) || 0), 0) / detail.progressItems.length;
        const updatedDetail = { ...detail, progressPercent: avgProgress };
        updateDetail(updatedDetail);
      };

      const addBudgetItem = async (detailId, item, file) => {
        let imageUrl = '';
        if (file) {
          const storageRef = storage.ref(`budget/${detailId}/${Date.now()}_${file.name}`);
          await storageRef.put(file);
          imageUrl = await storageRef.getDownloadURL();
        }
        const ref = db.ref(`details/${detailId}/budgetItems`).push();
        await ref.set({ ...item, imageUrl, createdAt: new Date().toISOString() });
        const newItem = { id: ref.key, ...item, imageUrl };
        setDetails(prev => prev.map(d => d.id === detailId ? {
          ...d,
          budgetItems: [...(d.budgetItems || []), newItem]
        } : d));
        recalculateDetailBudget(detailId);
      };

      const deleteBudgetItem = async (detailId, itemId) => {
        await db.ref(`details/${detailId}/budgetItems/${itemId}`).remove();
        setDetails(prev => prev.map(d => d.id === detailId ? {
          ...d,
          budgetItems: d.budgetItems.filter(i => i.id !== itemId)
        } : d));
        recalculateDetailBudget(detailId);
      };

      const recalculateDetailBudget = (detailId) => {
        const detail = details.find(d => d.id === detailId);
        if (!detail?.budgetItems?.length) return;
        const totalCost = detail.budgetItems.reduce((sum, i) => sum + (parseFloat(i.amount) || 0), 0);
        const updatedDetail = { ...detail, currentCost: totalCost };
        updateDetail(updatedDetail);
      };

      const importCSV = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        setFile(file);
        setImportModal(true);
      };

      const confirmImport = () => {
        const reader = new FileReader();
        reader.onload = async (e) => {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet);

          const newDetails = json.map(row => {
            const cat = categories.find(c => c.name === row.分项名称);
            return {
              projectId: currentProjectId,
              detailName: row.详细名称 || '未命名',
              categoryId: cat ? cat.id : categories[0]?.id || '1',
              budgetArea: parseFloat(row.预算面积) || null,
              budgetQuantity: parseFloat(row.预算用量) || 0,
              budgetCost: parseFloat(row.预算费用) || 0,
              currentQuantity: parseFloat(row.当前使用量) || 0,
              currentCost: parseFloat(row.当前使用费用) || 0,
              createdAt: new Date().toISOString(),
              progressItems: [],
              budgetItems: []
            };
          }).filter(d => d.detailName !== '未命名');

          const batch = {};
          newDetails.forEach(detail => {
            const ref = db.ref('details').push();
            batch[ref.key] = detail;
          });
          await db.ref('details').update(batch);
          setDetails(prev => [...prev, ...Object.values(batch).map((d, i) => ({ id: Object.keys(batch)[i], ...d }))]);

          const project = projects.find(p => p.id === currentProjectId);
          if (project) {
            const totalUsed = [...details, ...Object.values(batch)]
              .filter(d => d.projectId === currentProjectId)
              .reduce((sum, d) => sum + d.currentCost, 0);
            const progress = project.budgetValue > 0 ? (totalUsed / project.budgetValue) * 100 : 0;
            const updatedProject = { ...project, budgetUsed: totalUsed, progressPercent: progress };
            updateProject(updatedProject);
          }

          setImportModal(false);
          setFile(null);
          alert('导入成功！');
        };
        reader.readAsArrayBuffer(file);
      };

      const downloadTemplate = () => {
        const templateData = [
          { 详细名称: '北侧院墙砌筑', 分项名称: '院墙', 预算面积: 50, 预算用量: 100, 预算费用: 8000, 当前使用量: 95, 当前使用费用: 7600 },
          { 详细名称: '电源布线安装', 分项名称: '电源系统', 预算面积: '', 预算用量: 200, 预算费用: 15000, 当前使用量: 190, 当前使用费用: 14500 }
        ];
        const ws = XLSX.utils.json_to_sheet(templateData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, '明细导入');
        XLSX.writeFile(wb, '青灡居-明细导入模板.xlsx');
      };

      const downloadProgressTemplate = () => {
        const templateData = [
          { 条目名称: '墙角', 进展: 80 },
          { 条目名称: '墙体', 进展: 60 },
          { 条目名称: '墙瓦', 进展: 30 },
          { 条目名称: '墙床', 进展: 100 }
        ];
        const ws = XLSX.utils.json_to_sheet(templateData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, '工程进度导入');
        XLSX.writeFile(wb, '青灡居-工程进度导入模板.xlsx');
      };

      const filteredProjects = filterStatus === '全部'
        ? projects
        : projects.filter(p => p.status === filterStatus);

      const currentProject = projects.find(p => p.id === currentProjectId);
      const projectDetails = details.filter(d => d.projectId === currentProjectId);
      const filteredDetails = detailFilterCategory === '全部'
        ? projectDetails
        : projectDetails.filter(d => {
            const cat = categories.find(c => c.id === d.categoryId);
            return cat ? cat.name === detailFilterCategory : false;
          });

      const categoryStats = {};
      filteredDetails.forEach(d => {
        const cat = categories.find(c => c.id === d.categoryId);
        const name = cat?.name || '未知';
        if (!categoryStats[name]) {
          categoryStats[name] = { budgetCost: 0, currentCost: 0, budgetQuantity: 0, currentQuantity: 0 };
        }
        categoryStats[name].budgetCost += d.budgetCost;
        categoryStats[name].currentCost += d.currentCost;
        categoryStats[name].budgetQuantity += d.budgetQuantity;
        categoryStats[name].currentQuantity += d.currentQuantity;
      });

      const container = document.getElementById('root');
      const root = ReactDOM.createRoot(container);
      root.render(<App />);
    </script>
  </body>
</html>
